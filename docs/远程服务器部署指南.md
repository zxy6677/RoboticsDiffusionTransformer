# 远程服务器部署指南 🚀

## 服务器配置

### SSH 连接信息
```bash
# 跳板机
Host jump-server-tx
    HostName 134.175.121.223
    User zhukefei

# 目标服务器 (通过跳板机)
Host pro-20
    HostName 172.16.0.27
    User zhukefei
    ProxyJump jump-server-tx
```

### 快速连接
```bash
# 通过跳板机连接到目标服务器
ssh -J zhukefei@134.175.121.223 zhukefei@172.16.0.27
```

---

## 部署步骤

### 1. 本地代码更新到GitHub

```bash
cd /home/ubuntu/RoboticsDiffusionTransformer

# 添加所有修改
git add -A

# 提交更改
git commit -m "更新描述"

# 推送到GitHub
git push my-repo main
```

### 2. 远程服务器拉取代码

```bash
# 连接到远程服务器
ssh -J zhukefei@134.175.121.223 zhukefei@172.16.0.27

# 进入项目目录
cd ~/RoboticsDiffusionTransformer

# 拉取最新代码
git pull

# 如果有本地修改需要保存
git stash
git pull
git stash pop
```

### 3. 环境配置检查

在远程服务器上执行：

```bash
# 激活conda环境
conda activate rdt

# 检查GPU
nvidia-smi

# 检查Python环境
python -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA available: {torch.cuda.is_available()}'); print(f'GPU count: {torch.cuda.device_count()}')"
```

---

## 数据集配置

### 远程服务器数据集路径
```
/home/zhukefei/RoboticsDiffusionTransformer/data/datasets/libero_single_task/
```

### 训练脚本自动检测
训练脚本已修改为自动检测数据集路径：

```bash
# 优先级1: data/datasets/libero_single_task（远程服务器）
# 优先级2: datasets/libero_single_task（本地）
```

**无需手动修改路径！** 脚本会自动检测。

---

## 代码修复总结

### ✅ 已修复的绝对路径问题

#### 1. **训练数据加载** (`data/hdf5_libero_dataset.py`)
```python
# 修改前：硬编码相对路径
with open('configs/base.yaml', 'r') as file:
    config = yaml.safe_load(file)

# 修改后：使用相对于文件的路径
config_path = os.path.join(os.path.dirname(__file__), '..', 'configs', 'base.yaml')
with open(config_path, 'r') as file:
    config = yaml.safe_load(file)
```

#### 2. **评估脚本** (`eval_sim/eval_rdt_libero.py`)
```python
# 自动检测LIBERO路径
libero_path = os.environ.get("LIBERO_PATH")

if not libero_path:
    # 尝试几个可能的路径
    possible_paths = [
        "../LIBERO/libero/libero",  # 与项目同级
        "../../LIBERO/libero/libero",  # 上两级
        os.path.expanduser("~/LIBERO/libero/libero"),  # 用户目录
    ]
    for path in possible_paths:
        if os.path.exists(path):
            libero_path = path
            break
```

#### 3. **训练脚本** (`train_single_task.sh`, `train_single_task_2gpu.sh`)
```bash
# 自动检测数据集路径
if [ -d "./data/datasets/libero_single_task" ]; then
    export LIBERO_DATASET_DIR="./data/datasets/libero_single_task"
elif [ -d "./datasets/libero_single_task" ]; then
    export LIBERO_DATASET_DIR="./datasets/libero_single_task"
else
    echo "❌ 错误：未找到单任务数据集！"
    exit 1
fi
```

---

## 训练配置

### 8-GPU 训练 (远程服务器)

使用 `train_single_task_2gpu.sh` 脚本（已配置为8GPU）：

```bash
# 确保数据集在正确位置
ls -lh /home/zhukefei/RoboticsDiffusionTransformer/data/datasets/libero_single_task/

# 运行训练
bash train_single_task_2gpu.sh
```

### 训练配置参数
```bash
# GPU配置
export CUDA_VISIBLE_DEVICES=0,1,2,3,4,5,6,7

# 训练参数
--num_processes 8
--train_batch_size=4          # 每GPU batch size
--sample_batch_size=8
--max_train_steps=30000
--checkpointing_period=2000

# 总batch size = 4 * 8 = 32
```

### 预训练模型
```bash
# 远程服务器路径
/home/zhukefei/RoboticsDiffusionTransformer/checkpoints/rdt-1b/model.safetensors
```

---

## 训练前检查清单

### ✅ 必检项目

1. **GPU状态**
   ```bash
   nvidia-smi
   # 确认8张GPU都可用
   ```

2. **数据集存在**
   ```bash
   ls -lh data/datasets/libero_single_task/*.hdf5
   # 应该看到数据集文件
   ```

3. **统计文件正确**
   ```bash
   cat configs/dataset_stat.json | grep libero_single_task
   # 应该看到 libero_single_task 的统计信息
   ```

4. **训练脚本可执行**
   ```bash
   ls -l train_single_task_2gpu.sh
   # 应该有执行权限 (-rwxr-xr-x)
   ```

5. **预训练模型存在**
   ```bash
   ls -lh checkpoints/rdt-1b/model.safetensors
   # 应该显示模型文件大小
   ```

---

## 常见问题排查

### Q1: 找不到数据集
```bash
# 检查环境变量
echo $LIBERO_DATASET_DIR

# 检查目录
ls -lR data/datasets/
```

### Q2: GPU不可用
```bash
# 检查CUDA
nvidia-smi
nvcc --version

# 检查PyTorch
python -c "import torch; print(torch.cuda.is_available())"
```

### Q3: 导入错误
```bash
# 确保在项目根目录
pwd  # 应该显示 /home/zhukefei/RoboticsDiffusionTransformer

# 确保conda环境激活
conda info --envs
```

### Q4: 权限问题
```bash
# 添加执行权限
chmod +x train_single_task_2gpu.sh
```

---

## 监控训练

### 实时监控
```bash
# 查看GPU使用情况
watch -n 1 nvidia-smi

# 查看训练日志
tail -f nohup.out  # 如果使用nohup运行
```

### 检查checkpoint
```bash
# 查看已保存的checkpoint
ls -lh checkpoints/single_task_scene7/
```

### Weights & Biases (如果配置)
访问: https://wandb.ai/your-project

---

## 部署完成验证

### 1. 连接测试
```bash
ssh -J zhukefei@134.175.121.223 zhukefei@172.16.0.27 "echo '✅ SSH连接成功'"
```

### 2. 代码更新测试
```bash
ssh -J zhukefei@134.175.121.223 zhukefei@172.16.0.27 "cd ~/RoboticsDiffusionTransformer && git log --oneline -3"
```

### 3. 环境测试
```bash
ssh -J zhukefei@134.175.121.223 zhukefei@172.16.0.27 "cd ~/RoboticsDiffusionTransformer && conda activate rdt && python -c 'import torch; print(torch.cuda.device_count())'"
```

---

## 已完成的修复

### ✅ 2024-10-19 部署

1. **修复绝对路径问题**
   - 训练代码: 使用相对路径加载配置
   - 评估代码: LIBERO路径自动检测
   - 训练脚本: 数据集路径自动检测

2. **更新代码到GitHub**
   - 提交: `fc33c02` - 修复绝对路径问题
   - 提交: `442374d` - 添加完整代码和文档

3. **远程服务器代码更新**
   - ✅ 代码已pull到最新版本
   - ✅ 冲突已解决
   - ✅ 训练脚本已就绪

---

## 下一步

### 开始训练
```bash
# 1. 连接到远程服务器
ssh -J zhukefei@134.175.121.223 zhukefei@172.16.0.27

# 2. 进入项目目录
cd ~/RoboticsDiffusionTransformer

# 3. 激活环境
conda activate rdt

# 4. 运行训练（前台）
bash train_single_task_2gpu.sh

# 或者后台运行
nohup bash train_single_task_2gpu.sh > train.log 2>&1 &

# 查看进程
ps aux | grep accelerate
```

### 监控和调试
```bash
# 实时查看日志
tail -f train.log

# 查看GPU使用
watch -n 1 nvidia-smi

# 检查checkpoint
ls -lht checkpoints/single_task_scene7/ | head
```

---

## 联系信息

- **GitHub仓库**: https://github.com/zxy6677/RoboticsDiffusionTransformer
- **服务器**: pro-20 (172.16.0.27)
- **跳板机**: jump-server-tx (134.175.121.223)

---

**状态**: ✅ 部署完成，准备开始训练

**最后更新**: 2024-10-19

