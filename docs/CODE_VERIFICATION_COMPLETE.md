# RDT-LIBERO 代码完整验证结果

## 📅 验证日期
2025-10-17

## ✅ 已验证正确的部分

### 1. 6D旋转转换 ✅
- **测试**: 使用实际LIBERO数据测试往返转换
- **结果**: 误差 < 1e-6，完全可逆
- **结论**: `utils/rotation_utils.py` 实现完全正确

### 2. 数据缩放因子 ✅  
- **测试**: 对比action和实际EEF位移
- **发现**: 实际缩放因子约为 0.013，使用 0.012 非常接近
- **结论**: 缩放因子正确

### 3. 坐标系方向 ✅
- **测试**: 检查action和EEF位移的符号关系
- **结果**: X轴 ✓, Y轴 ✓, Z轴 ✓（全部一致）
- **结论**: RDT和LIBERO使用相同的坐标系，无需翻转

### 4. 训练代码数据处理 ✅
**流程**:
```
LIBERO action (归一化[-1, 1])
  ↓ ×0.012
物理单位 (米)
  ↓ 填入state_vec[30:33]
RDT训练数据 (128维)
```

**验证结果**: 往返转换误差 = 0

### 5. 评估代码数据处理 ✅
**流程**:
```
RDT输出 (128维)
  ↓ 提取state_vec[30:33]
物理单位 (米)
  ↓ ÷0.012
LIBERO action (归一化[-1, 1])
```

**验证结果**: 往返转换误差 = 0

### 6. State构建 ✅
**评估时State构建**:
- 正确提取 `robot0_eef_pos` (3维)
- 正确转换 `robot0_eef_quat` → 6D rotation (6维)
- 正确提取 `robot0_joint_pos` (7维)
- 正确映射到RDT的128维空间

## ❓ 那么问题出在哪里？

### 关键观察
用户报告：**"模型输出轨迹和训练时的演示轨迹刚好相反，左右上下前后都是相反的"**

### 可能的原因

#### 1. 模型学习问题（最可能）
- **训练不充分**: 26000步可能不够
- **数据量不足**: LIBERO数据集规模
- **超参数**: 学习率、batch size等
- **模型容量**: 1B参数对于新任务可能需要更多训练

#### 2. 推理时的问题
- **History处理**: 模型使用历史观察，历史构建是否正确？
- **Normalization**: dataset_stat.json是否正确？
- **图像预处理**: 图像编码是否与训练时一致？

#### 3. 环境交互问题
- **Action执行**: LIBERO环境的action执行是否正确？
- **观察获取**: 评估时获取的观察是否与训练数据一致？

### 需要进一步检查的点

1. **训练loss曲线**
   - Loss是否收敛？
   - 是否过拟合或欠拟合？

2. **Dataset statistics**
   - `configs/dataset_stat.json` 是否正确计算？
   - 是否用正确的数据重新计算过？

3. **History window**
   - 推理时的history构建是否正确？
   - 是否与训练时一致？

4. **实际模型预测值**
   - 在评估时打印模型的原始输出
   - 对比demo的实际值
   - 看看数值和符号

## 🎯 建议的下一步

### 选项A: Debug实际推理过程（推荐）
创建一个脚本，在实际评估时打印：
1. 输入的observation（图像+state）
2. 模型的原始输出（128维）
3. 转换后的action
4. Demo的action（对比）
5. 实际执行效果

这样可以精确定位问题所在。

### 选项B: 检查训练状态
1. 查看训练loss曲线
2. 检查dataset_stat.json
3. 确认训练是否正常收敛

### 选项C: 简化测试
1. 用最简单的任务测试（只有一个动作）
2. 逐步增加复杂度
3. 定位到底是哪个环节出问题

## 📝 已排除的可能性

- ❌ 6D旋转转换错误
- ❌ 坐标系不匹配
- ❌ 缩放因子错误
- ❌ 数值处理错误  
- ❌ 训练代码的数据加载错误
- ❌ 评估代码的动作转换错误

## 🔍 核心发现

**所有的数据处理代码都是正确的！**

如果模型输出方向完全相反，只有两种可能：
1. 模型根本没学对（训练问题）
2. 推理时某个环节搞反了（但不在我们已检查的部分）

建议先用checkpoint-26000实际测试一下，打印出模型的预测值和demo的真实值进行对比。





