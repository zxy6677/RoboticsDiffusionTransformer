# 训练配置总结

## ✅ 已完成的所有配置和修复

### 1. 数据集路径配置 ✅

**新数据集路径**：
```bash
/home/ubuntu/RoboticsDiffusionTransformer/datasets/libero_single_task/
```

**包含文件**：
- `KITCHEN_SCENE10_close_the_top_drawer_of_the_cabinet_and_put_the_black_bowl_on_top_of_it_demo.hdf5`
- 文件大小：1013M
- 任务：关闭抽屉并把碗放在柜子上

---

### 2. Bug修复总结 ✅

#### Bug 1: Position Scaling错误（评估时）
- **问题**：位置动作被错误放大100倍
- **修复**：`eval_sim/eval_rdt_libero.py`
- **效果**：Episode存活时间从15步提升到246步

#### Bug 2: Loss Weighting错误（训练时）
- **问题**：使用了libero_90（90任务）统计训练单任务
- **修复**：计算并使用正确的单任务统计
- **效果**：Position loss权重从100倍错误修复为正确值

---

### 3. 训练脚本配置 ✅

#### 单GPU训练脚本：`train_single_task.sh`
```bash
export LIBERO_DATASET_DIR="/home/ubuntu/RoboticsDiffusionTransformer/datasets/libero_single_task/"
export CUDA_VISIBLE_DEVICES=1
python main.py --train_batch_size=8 ...
```

#### 2-GPU训练脚本：`train_single_task_2gpu.sh` ⭐
```bash
export LIBERO_DATASET_DIR="/home/ubuntu/RoboticsDiffusionTransformer/datasets/libero_single_task/"
export CUDA_VISIBLE_DEVICES=0,1
accelerate launch --num_processes 2 --multi_gpu main.py --train_batch_size=16 ...
```

---

### 4. 自动检测机制 ✅

**文件**：`data/hdf5_libero_dataset.py`

**功能**：
- 自动检测数据集路径中是否包含 `libero_single_task`
- 如果是单任务数据集，自动使用正确的统计信息
- 避免loss weighting错误

**验证输出**：
```
🔍 检测到单任务训练，使用 libero_single_task 统计信息
   数据集路径: /home/ubuntu/RoboticsDiffusionTransformer/datasets/libero_single_task/
✅ Action std (position x,y,z): [0.328, 0.467, 0.486]
✅ Action std (gripper): 0.479
```

---

## 🚀 开始训练

### 选项1：单GPU训练
```bash
bash train_single_task.sh
```
- 使用GPU 1
- Batch size: 8
- 预计时间：~28小时（20K步）

### 选项2：2-GPU训练（推荐！⚡）
```bash
bash train_single_task_2gpu.sh
```
- 使用GPU 0和1
- Batch size: 16（每GPU: 8）
- 预计时间：~15小时（20K步）
- **节省13小时！**

---

## 📊 配置对比

| 项目 | 单GPU | 2-GPU |
|------|-------|-------|
| **GPU** | 1张 (GPU 1) | 2张 (GPU 0,1) |
| **Batch Size** | 8 | 16 |
| **Workers** | 4 | 8 |
| **训练速度** | 1.0x | ~1.8x |
| **20K步时间** | ~28小时 | ~15小时 |
| **显存使用** | ~35GB | ~35GB (每卡) |

---

## 🔍 监控命令

### 实时监控GPU
```bash
watch -n 1 nvidia-smi
```

### 查看训练日志
```bash
# 单GPU
tail -f checkpoints/single_task_scene10/training.log

# 2-GPU
tail -f checkpoints/single_task_scene10_2gpu/training.log
```

---

## ✅ 验证清单

训练开始时应该看到：

- [x] `🔍 检测到单任务训练，使用 libero_single_task 统计信息`
- [x] `数据集路径: /home/ubuntu/RoboticsDiffusionTransformer/datasets/libero_single_task/`
- [x] `找到1个HDF5文件`
- [x] Position std: [0.328, 0.467, 0.486]（正确值！）
- [x] 2-GPU训练：`world_size=2, rank=0/1`

---

## 📈 预期改进

### 相比修复前

| 指标 | 修复前 | 修复后 |
|------|--------|--------|
| **Episode存活** | 15步 | 246步 ✅ |
| **Position loss权重** | 错误（100倍） | 正确 ✅ |
| **训练任务表现** | 反而差 | 应该显著改善 ✅ |

### 修复后预期

1. ✅ Position动作范围正确（不会放大100倍）
2. ✅ Loss weighting正确（所有维度平衡）
3. ✅ 训练任务（关闭抽屉+放碗）成功率提升
4. ✅ Position、Rotation、Gripper协调一致

---

## 🎯 下一步

### 立即开始训练（推荐2-GPU）
```bash
bash train_single_task_2gpu.sh
```

### 训练完成后评估
```bash
export CUDA_VISIBLE_DEVICES=0

python eval_sim/eval_rdt_libero.py \
    --config configs/base.yaml \
    --pretrained checkpoints/single_task_scene10_2gpu/checkpoint-19000/ema/model.safetensors \
    --text_encoder google/t5-v1_1-xxl \
    --vision_encoder google/siglip-so400m-patch14-384 \
    --benchmark libero_90 \
    --num_tasks 2 \
    --max_steps 200 \
    --exec_horizon 16 \
    --record_video \
    --video_output_dir videos/final_eval
```

---

## 📝 关键文件

### 训练脚本
- `train_single_task.sh` - 单GPU训练
- `train_single_task_2gpu.sh` - 2-GPU训练（推荐）

### 评估脚本
- `eval_sim/eval_rdt_libero.py` - 包含Position Scaling修复

### 配置文件
- `configs/dataset_stat.json` - 包含单任务统计
- `configs/base.yaml` - 基础配置

### 数据处理
- `data/hdf5_libero_dataset.py` - 自动检测机制
- `compute_single_task_stat.py` - 统计计算工具

---

## 💡 重要提示

### 所有Bug都已修复！

1. ✅ **Position Scaling bug** - 评估时100倍错误
2. ✅ **Loss Weighting bug** - 训练时100倍错误
3. ✅ **数据集路径** - 已更新为正确路径
4. ✅ **自动检测** - 确保使用正确统计

### 使用2-GPU训练的优势

- ⚡ 速度快1.8倍
- 💾 节省13小时
- 🎯 配置简单
- ✅ 所有修复已包含

---

**现在可以开始训练了！预期效果会比之前好很多！** 🚀

**推荐命令**：
```bash
bash train_single_task_2gpu.sh
```


