# è®­ç»ƒé…ç½®æ€»ç»“

## âœ… å·²å®Œæˆçš„æ‰€æœ‰é…ç½®å’Œä¿®å¤

### 1. æ•°æ®é›†è·¯å¾„é…ç½® âœ…

**æ–°æ•°æ®é›†è·¯å¾„**ï¼š
```bash
/home/ubuntu/RoboticsDiffusionTransformer/datasets/libero_single_task/
```

**åŒ…å«æ–‡ä»¶**ï¼š
- `KITCHEN_SCENE10_close_the_top_drawer_of_the_cabinet_and_put_the_black_bowl_on_top_of_it_demo.hdf5`
- æ–‡ä»¶å¤§å°ï¼š1013M
- ä»»åŠ¡ï¼šå…³é—­æŠ½å±‰å¹¶æŠŠç¢—æ”¾åœ¨æŸœå­ä¸Š

---

### 2. Bugä¿®å¤æ€»ç»“ âœ…

#### Bug 1: Position Scalingé”™è¯¯ï¼ˆè¯„ä¼°æ—¶ï¼‰
- **é—®é¢˜**ï¼šä½ç½®åŠ¨ä½œè¢«é”™è¯¯æ”¾å¤§100å€
- **ä¿®å¤**ï¼š`eval_sim/eval_rdt_libero.py`
- **æ•ˆæœ**ï¼šEpisodeå­˜æ´»æ—¶é—´ä»15æ­¥æå‡åˆ°246æ­¥

#### Bug 2: Loss Weightingé”™è¯¯ï¼ˆè®­ç»ƒæ—¶ï¼‰
- **é—®é¢˜**ï¼šä½¿ç”¨äº†libero_90ï¼ˆ90ä»»åŠ¡ï¼‰ç»Ÿè®¡è®­ç»ƒå•ä»»åŠ¡
- **ä¿®å¤**ï¼šè®¡ç®—å¹¶ä½¿ç”¨æ­£ç¡®çš„å•ä»»åŠ¡ç»Ÿè®¡
- **æ•ˆæœ**ï¼šPosition lossæƒé‡ä»100å€é”™è¯¯ä¿®å¤ä¸ºæ­£ç¡®å€¼

---

### 3. è®­ç»ƒè„šæœ¬é…ç½® âœ…

#### å•GPUè®­ç»ƒè„šæœ¬ï¼š`train_single_task.sh`
```bash
export LIBERO_DATASET_DIR="/home/ubuntu/RoboticsDiffusionTransformer/datasets/libero_single_task/"
export CUDA_VISIBLE_DEVICES=1
python main.py --train_batch_size=8 ...
```

#### 2-GPUè®­ç»ƒè„šæœ¬ï¼š`train_single_task_2gpu.sh` â­
```bash
export LIBERO_DATASET_DIR="/home/ubuntu/RoboticsDiffusionTransformer/datasets/libero_single_task/"
export CUDA_VISIBLE_DEVICES=0,1
accelerate launch --num_processes 2 --multi_gpu main.py --train_batch_size=16 ...
```

---

### 4. è‡ªåŠ¨æ£€æµ‹æœºåˆ¶ âœ…

**æ–‡ä»¶**ï¼š`data/hdf5_libero_dataset.py`

**åŠŸèƒ½**ï¼š
- è‡ªåŠ¨æ£€æµ‹æ•°æ®é›†è·¯å¾„ä¸­æ˜¯å¦åŒ…å« `libero_single_task`
- å¦‚æœæ˜¯å•ä»»åŠ¡æ•°æ®é›†ï¼Œè‡ªåŠ¨ä½¿ç”¨æ­£ç¡®çš„ç»Ÿè®¡ä¿¡æ¯
- é¿å…loss weightingé”™è¯¯

**éªŒè¯è¾“å‡º**ï¼š
```
ğŸ” æ£€æµ‹åˆ°å•ä»»åŠ¡è®­ç»ƒï¼Œä½¿ç”¨ libero_single_task ç»Ÿè®¡ä¿¡æ¯
   æ•°æ®é›†è·¯å¾„: /home/ubuntu/RoboticsDiffusionTransformer/datasets/libero_single_task/
âœ… Action std (position x,y,z): [0.328, 0.467, 0.486]
âœ… Action std (gripper): 0.479
```

---

## ğŸš€ å¼€å§‹è®­ç»ƒ

### é€‰é¡¹1ï¼šå•GPUè®­ç»ƒ
```bash
bash train_single_task.sh
```
- ä½¿ç”¨GPU 1
- Batch size: 8
- é¢„è®¡æ—¶é—´ï¼š~28å°æ—¶ï¼ˆ20Kæ­¥ï¼‰

### é€‰é¡¹2ï¼š2-GPUè®­ç»ƒï¼ˆæ¨èï¼âš¡ï¼‰
```bash
bash train_single_task_2gpu.sh
```
- ä½¿ç”¨GPU 0å’Œ1
- Batch size: 16ï¼ˆæ¯GPU: 8ï¼‰
- é¢„è®¡æ—¶é—´ï¼š~15å°æ—¶ï¼ˆ20Kæ­¥ï¼‰
- **èŠ‚çœ13å°æ—¶ï¼**

---

## ğŸ“Š é…ç½®å¯¹æ¯”

| é¡¹ç›® | å•GPU | 2-GPU |
|------|-------|-------|
| **GPU** | 1å¼  (GPU 1) | 2å¼  (GPU 0,1) |
| **Batch Size** | 8 | 16 |
| **Workers** | 4 | 8 |
| **è®­ç»ƒé€Ÿåº¦** | 1.0x | ~1.8x |
| **20Kæ­¥æ—¶é—´** | ~28å°æ—¶ | ~15å°æ—¶ |
| **æ˜¾å­˜ä½¿ç”¨** | ~35GB | ~35GB (æ¯å¡) |

---

## ğŸ” ç›‘æ§å‘½ä»¤

### å®æ—¶ç›‘æ§GPU
```bash
watch -n 1 nvidia-smi
```

### æŸ¥çœ‹è®­ç»ƒæ—¥å¿—
```bash
# å•GPU
tail -f checkpoints/single_task_scene10/training.log

# 2-GPU
tail -f checkpoints/single_task_scene10_2gpu/training.log
```

---

## âœ… éªŒè¯æ¸…å•

è®­ç»ƒå¼€å§‹æ—¶åº”è¯¥çœ‹åˆ°ï¼š

- [x] `ğŸ” æ£€æµ‹åˆ°å•ä»»åŠ¡è®­ç»ƒï¼Œä½¿ç”¨ libero_single_task ç»Ÿè®¡ä¿¡æ¯`
- [x] `æ•°æ®é›†è·¯å¾„: /home/ubuntu/RoboticsDiffusionTransformer/datasets/libero_single_task/`
- [x] `æ‰¾åˆ°1ä¸ªHDF5æ–‡ä»¶`
- [x] Position std: [0.328, 0.467, 0.486]ï¼ˆæ­£ç¡®å€¼ï¼ï¼‰
- [x] 2-GPUè®­ç»ƒï¼š`world_size=2, rank=0/1`

---

## ğŸ“ˆ é¢„æœŸæ”¹è¿›

### ç›¸æ¯”ä¿®å¤å‰

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **Episodeå­˜æ´»** | 15æ­¥ | 246æ­¥ âœ… |
| **Position lossæƒé‡** | é”™è¯¯ï¼ˆ100å€ï¼‰ | æ­£ç¡® âœ… |
| **è®­ç»ƒä»»åŠ¡è¡¨ç°** | åè€Œå·® | åº”è¯¥æ˜¾è‘—æ”¹å–„ âœ… |

### ä¿®å¤åé¢„æœŸ

1. âœ… PositionåŠ¨ä½œèŒƒå›´æ­£ç¡®ï¼ˆä¸ä¼šæ”¾å¤§100å€ï¼‰
2. âœ… Loss weightingæ­£ç¡®ï¼ˆæ‰€æœ‰ç»´åº¦å¹³è¡¡ï¼‰
3. âœ… è®­ç»ƒä»»åŠ¡ï¼ˆå…³é—­æŠ½å±‰+æ”¾ç¢—ï¼‰æˆåŠŸç‡æå‡
4. âœ… Positionã€Rotationã€Gripperåè°ƒä¸€è‡´

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### ç«‹å³å¼€å§‹è®­ç»ƒï¼ˆæ¨è2-GPUï¼‰
```bash
bash train_single_task_2gpu.sh
```

### è®­ç»ƒå®Œæˆåè¯„ä¼°
```bash
export CUDA_VISIBLE_DEVICES=0

python eval_sim/eval_rdt_libero.py \
    --config configs/base.yaml \
    --pretrained checkpoints/single_task_scene10_2gpu/checkpoint-19000/ema/model.safetensors \
    --text_encoder google/t5-v1_1-xxl \
    --vision_encoder google/siglip-so400m-patch14-384 \
    --benchmark libero_90 \
    --num_tasks 2 \
    --max_steps 200 \
    --exec_horizon 16 \
    --record_video \
    --video_output_dir videos/final_eval
```

---

## ğŸ“ å…³é”®æ–‡ä»¶

### è®­ç»ƒè„šæœ¬
- `train_single_task.sh` - å•GPUè®­ç»ƒ
- `train_single_task_2gpu.sh` - 2-GPUè®­ç»ƒï¼ˆæ¨èï¼‰

### è¯„ä¼°è„šæœ¬
- `eval_sim/eval_rdt_libero.py` - åŒ…å«Position Scalingä¿®å¤

### é…ç½®æ–‡ä»¶
- `configs/dataset_stat.json` - åŒ…å«å•ä»»åŠ¡ç»Ÿè®¡
- `configs/base.yaml` - åŸºç¡€é…ç½®

### æ•°æ®å¤„ç†
- `data/hdf5_libero_dataset.py` - è‡ªåŠ¨æ£€æµ‹æœºåˆ¶
- `compute_single_task_stat.py` - ç»Ÿè®¡è®¡ç®—å·¥å…·

---

## ğŸ’¡ é‡è¦æç¤º

### æ‰€æœ‰Bugéƒ½å·²ä¿®å¤ï¼

1. âœ… **Position Scaling bug** - è¯„ä¼°æ—¶100å€é”™è¯¯
2. âœ… **Loss Weighting bug** - è®­ç»ƒæ—¶100å€é”™è¯¯
3. âœ… **æ•°æ®é›†è·¯å¾„** - å·²æ›´æ–°ä¸ºæ­£ç¡®è·¯å¾„
4. âœ… **è‡ªåŠ¨æ£€æµ‹** - ç¡®ä¿ä½¿ç”¨æ­£ç¡®ç»Ÿè®¡

### ä½¿ç”¨2-GPUè®­ç»ƒçš„ä¼˜åŠ¿

- âš¡ é€Ÿåº¦å¿«1.8å€
- ğŸ’¾ èŠ‚çœ13å°æ—¶
- ğŸ¯ é…ç½®ç®€å•
- âœ… æ‰€æœ‰ä¿®å¤å·²åŒ…å«

---

**ç°åœ¨å¯ä»¥å¼€å§‹è®­ç»ƒäº†ï¼é¢„æœŸæ•ˆæœä¼šæ¯”ä¹‹å‰å¥½å¾ˆå¤šï¼** ğŸš€

**æ¨èå‘½ä»¤**ï¼š
```bash
bash train_single_task_2gpu.sh
```


